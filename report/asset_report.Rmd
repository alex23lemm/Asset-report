
<img src="figure/logo.png" style="float: right;" />
&nbsp;
&nbsp;
&nbsp;

# Prime Asset Report 

```{r echo=FALSE, message=FALSE, warning=FALSE}

library(dplyr)
library(tidyr)
library(ggplot2)
library(grid)
library(lubridate)
library(readxl)

source("../RScripts/utils.R")


assets_lc_df <- read_excel("../data/lc_asset_list_processed.xlsx") %>%
  mutate(
    date_created = ymd_hms(date_created),
    date_last_modified = ymd_hms(date_last_modified)
  )

assets_aris_df <- read_excel("../data/aris_asset_list_processed.xlsx") %>% 
    process_aris_data

date_of_extraction <- read.csv("../data/date_of_extraction.csv")


```


Data as of  **`r as.character(date_of_extraction[1,])`**

## General Information 

The `Prime Asset Report` provides information about released Prime assets from a LabCase and from a ARIS point of view. 
In the first chapter `LabCase asset anaylsis ` we examine assets which are stored in the [main Prime project](https://labcase.softwareag.com/projects/prime/alfresco/documents) in LabCase in one of the methodology-specific folders. Those assets are available to our user base via the GCS Portal search. 

In the second chapter `ARIS asset analysis` we examine assets objects which are part of the latest Prime ARIS release database. Those assets are available to our user base via ARIS Connect/ARIS Client.

In the third part we merge the LabCase data set and the ARIS data set in order to reveal which assets are not mentinoned/listed in the other system and vice versa.




## LabCase asset anaylsis

All information below was gathered by extracting file information using the [LabCase Assets API](https://labcase.softwareag.com/projects/labcase/wiki/LabCase_Asset_API). Currently, the API does not support tags. Therefore, only available file metadata information like `date created`, `date modified`, `folder stored` was processed. In contrast, tag information like, for instance, `asset type` or `scope of usage` could not be taken into account. 

* **Total** number of LabCase **assets**: **`r nrow(assets_lc_df)`**

### Creation history

All charts in this section deal with the original date the assets were created and stored in the main Prime project.

```{r echo=FALSE, warning=FALSE, fig.width=12}

assets_created_by_year <- assets_lc_df %>%
  count(year_created) %>%
  replace_na(list(year_created = "Unknown")) %>%
  {max_val <<- max(.$n)
  sum_val <<- sum(.$n)
  . }  %>%
  ggplot(aes(year_created, n)) + 
    geom_bar(stat = "identity", fill = "#0899CC") +
    geom_text(aes(label = n), vjust = -0.2) +
    xlab("Year") +
    ylab("Number of assets") +
    ggtitle(paste0("Assets created by year (", sum_val, " overall)")) +
    ylim(0, max_val * 1.02) +
    theme_bw() +
    theme(plot.title = element_text(size = rel(1.3)),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10)) 
    


assets_created_by_method <- assets_lc_df %>%
  count(method_acronym) %>%
  {max_val <<- max(.$n)
  sum_val <<- sum(.$n)
  . } %>%
  ggplot(aes(reorder(method_acronym, n), n)) +
    geom_bar(stat = "identity", fill = "#0899CC") +
    geom_text(aes(label = n), hjust = -0.2) +
    xlab("Methodology") +
    ylab("Number of assets") +
    ggtitle(paste0("Assets created by methodology (", sum_val, " overall)")) +
    ylim(0, max_val * 1.06) +
    coord_flip() +
    theme_bw() +
    theme(plot.title = element_text(size = rel(1.3)),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10)) 
    


# Layout plots side-by-side on a 2-row-2-column grid
grid.newpage()
# Push viewport to graphic device
pushViewport(viewport(layout = grid.layout(2, 2)))
print(assets_created_by_year, vp = viewport(layout.pos.row = 1:2, layout.pos.col = 1))
print(assets_created_by_method, vp = viewport(layout.pos.row = 1:2, layout.pos.col = 2))


```


```{r echo=FALSE, warning=FALSE, fig.width=8, fig.height=8}

assets_lc_df %>%
  count(year_created, method_acronym) %>%
  group_by(method_acronym) %>%
  mutate(
    method_plus_numb = paste0(method_acronym, " (", sum(n), " overall)")
  ) %>% 
  replace_na(list(year_created = "Unknown")) %>%
  {max_val <<- max(.$n) 
  .} %>%
  ggplot(aes(year_created, n)) +
    geom_bar(stat = "identity", fill = "#0899CC") +
    geom_text(aes(label = n), vjust = -0.2) +
    xlab("Year") +
    ylab("Number of assets") +
    ggtitle("Assets created by methodology and year") +
    ylim(0, max_val * 1.13) +
    facet_wrap(~ method_plus_numb, ncol = 3) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
          plot.title = element_text(size = rel(1.3)),
          axis.title = element_text(size = 12),
          axis.text = element_text(size = 10),
          strip.text.x = element_text(size = 12))

```

### Update history and Q&A

All charts in this section deal with the date the assets were updated the last time in the main Prime project. In addition, we highight several Q&A related topics and show areas which need to be further examined or fixed. 

* Assets with missing description: **`r sum(assets_lc_df$description == "")`**

* Assets with missing title: **`r sum(assets_lc_df$title == "")`**

* Year the last asset update falls into:

```{r echo=FALSE, warning=FALSE}

assets_lc_df %>% 
  count(year_last_modified) %>%
  replace_na(list(
    year_last_modified = "Unknown"
  )) %>%
  {max_val <<- max(.$n)
  sum_val <<- sum(.$n)
  .  
  } %>%
  ggplot(aes(year_last_modified, n)) +
    geom_bar(stat = "identity", fill = "#0899CC") +
    geom_text(aes(label = n), vjust = -0.2) +
    xlab("Year") +
    ylab("Number of assets") +
    ylim(0, max_val * 1.08) +
    ggtitle(paste0("Assets by latest update year (",
                   sum_val, " overall)")) +
    theme_bw() +
    theme(plot.title = element_text(size = rel(1.3)),
          axis.title = element_text(size = 12),
          axis.text = element_text(size = 10)) 
    


```

* Year the last asset update falls into by methodology:

```{r echo=FALSE, warning=FALSE, fig.width=8, fig.height=8}

assets_lc_df %>% 
  count(method_acronym, year_last_modified) %>%
  group_by(method_acronym) %>%
  mutate(
    method_plus_numb = paste0(method_acronym, " (", sum(n), " overall)")
  ) %>% 
  replace_na(list(
    year_last_modified = "Unknown"
  )) %>%
  {max_val <<- max(.$n)
  sum_val <<- sum(.$n)
  .  
  } %>%
  ggplot(aes(year_last_modified, n)) +
    geom_bar(stat = "identity", fill = "#0899CC") +
    geom_text(aes(label = n), vjust = -0.2) +
    xlab("Year") +
    ylab("Number of assets") +
    ylim(0, max_val * 1.08) +
    ggtitle(paste0("Assets by methodology and latest update year (",
                   sum_val, " overall)")) +
    facet_wrap(~ method_plus_numb) +
    theme_bw() +
    theme(plot.title = element_text(size = rel(1.3)),
          axis.title = element_text(size = 12),
          axis.text = element_text(size = 10),
          strip.text.x = element_text(size = 12),
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) 
    


```



### Recent activities 

In this section we visualize the recent activities of the **current year `r year(now())`**. In particular, we examine the latest asset additions and modifications. Double counting is avoided completely: If a particular asset was **created AND modified in the current year**, it will **only be counted once** and **assigned to the `created` category**. In contrast, an **asset modified in the current year but created in a previous year** will be **flagged as `updated`**.


```{r echo=FALSE, warning=FALSE}

assets_lc_df %>% 
  filter(year_last_modified == year(date_of_extraction[, 1]) | 
         year_created == year(date_of_extraction[, 1])) %>%
  mutate(
    activity = ifelse(year_last_modified > year_created, "Updated", "Created"),
    #Workaround to deal with missing created_at information until API is fixed
    activity = ifelse(is.na(activity), "Updated", activity),
    quarter = ifelse(activity == "Updated", quarters(date_last_modified),
                     quarters(date_created))
  ) %>%
  count(quarter, activity) %>%
  group_by(activity) %>%
  mutate(
    activity_plus_numb = paste0(activity, " (", sum(n), " overall)")
  ) %>%
  {max_val <<- max(.$n)
  sum_val <<- sum(.$n)
  .
  } %>%
  ggplot(aes(quarter, n)) +
    geom_bar(stat = "identity", position = "dodge", fill = "#0899CC") +
    geom_text(aes(label = n), vjust = -0.2) +
    xlab("Quarter of creation/update") +
    ylab("Number of assets") +
    ylim(0, max_val * 1.08) +
    ggtitle(paste0("Assets created/updated in ", year(date_of_extraction[, 1]),
                   " (", sum_val, " overall)\n by quarter")) +
    facet_wrap( ~activity_plus_numb) +
    theme_bw() +
    theme(plot.title = element_text(size = rel(1.3)),
          axis.title = element_text(size = 12),
          axis.text = element_text(size = 10),
          strip.text.x = element_text(size = 12)) 

```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.height=9}

tt <- assets_lc_df %>% 
  filter(year_last_modified == year(date_of_extraction[, 1]) | 
         year_created == year(date_of_extraction[, 1])) %>%
  mutate(
    activity = ifelse(year_last_modified > year_created, "Updated", "Created"),
    #Workaround to deal with missing created_at information until API is fixed
    activity = ifelse(is.na(activity), "Updated", activity),
    quarter = ifelse(activity == "Updated", quarters(date_last_modified),
                     quarters(date_created))
  ) %>%
  count(method_acronym, quarter, activity) %>% 
  bind_rows(., expand.grid(method_acronym = levels(as.factor(.$method_acronym)),
                              quarter = levels(as.factor(.$quarter)),
                              activity = levels(as.factor(.$activity)),
                              n = NA)) %>%
  group_by(method_acronym) %>%
  mutate(
    method_plus_numb = paste0(method_acronym, " (", sum(n), " overall)")
  ) %>% 
  rename(
    Activity = activity
  ) %>%
  {max_val <<- max(.$n)
  sum_val <<- sum(.$n)
  .} %>%
  ggplot(aes(quarter, n, fill = Activity)) +
    geom_bar(stat = "identity", position = "dodge") +
    geom_text(aes(label = n), position = position_dodge(.9), vjust = -0.2) +
    xlab("Quarter of creation/update") +
    ylab("Number of assets") +
    ylim(0, max_val * 1.09) +
    #coord_flip()
    ggtitle(paste0("Assets created/updated in ", year(date_of_extraction[, 1]),
                   " (", sum_val, " overall)\n by methodology and quarter")) +
    facet_wrap( ~ method_plus_numb) +
    scale_fill_manual(values = c("#04B2E0", "#666666")) +
    theme_bw() +
    theme(plot.title = element_text(size = rel(1.3)),
          axis.title = element_text(size = 12),
          axis.text = element_text(size = 10),
          strip.text.x = element_text(size = 12)) 

```

### Provided file types

```{r echo=FALSE, warning=FALSE}

assets_lc_df %>%
  count(file_type) %>%
  {sum_val <<- sum(.$n)
  max_val <<- max(.$n)
  . } %>%
  ggplot(aes(reorder(file_type, n), n)) +
    geom_bar(stat = "identity", fill = "#0899CC") +
    geom_text(aes(label = n), hjust = -0.2) +
    xlab("File type") +
    ylab("Number of assets") +
    ggtitle(paste0("Assets by file type (", sum_val, " overall)")) +
    ylim(0, max_val * 1.06) +
    coord_flip() +
    theme_bw() +
    theme(plot.title = element_text(size = rel(1.3)),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10)) 

```

## ARIS asset analysis

All information below was calculated based on an ARIS report that was extracted form the latest Prime ARIS release database. 

* **Total** number of ARIS **assets**: **`r nrow(assets_aris_df)`**


### Provided asset types


```{r echo=FALSE}


assets_aris_df %>% 
  count(Prime_Asset_Type) %>%
  ggplot(aes(reorder(Prime_Asset_Type, n), n)) +
    geom_bar(stat = "identity", fill = "#0899CC") +
    geom_text(aes(label = n), hjust = -0.2) +
    coord_flip() +
    theme_bw()

```

### Link 1 attribute investigation

The `Link 1` attribute is by far the most important information because parts of it (the Alfresco ID) will be used as the primary key to merge the LabCasa asset data with the ARIS asset data later. 


```{r echo=FALSE, fig.height=6, fig.width=6}

assets_aris_df %>% 
  select(labcase_id) %>%
  mutate(
    labcase_id = ifelse(is.na(labcase_id), "LC link missing", "LC link present")
  )  %>% 
  ggplot(aes(labcase_id)) +
    geom_bar(fill = "#0899CC") +
    geom_text(stat = 'bin', aes(label= ..count..), vjust = -1) +
    theme_bw() 


```

* Of `r nrow(assets_aris_df)` assets in ARIS `r sum(!is.na(assets_aris_df$labcase_id))` possess a `Link 1` attribute

* Examing the `Link 1` attribute further reveals that only `r sum(!is.na(unique(assets_aris_df$labcase_id)))` are really unique. This corresponds to the number of ARIS assets we can expect to successfully merge the most with the LabCase data by `Alfresco ID` later

* The following ARIS assets share the same `Link 1` attribute and should be further examined and merged in ARIS:

```{r echo=FALSE}

kable(assets_aris_df %>% 
  filter(!is.na(labcase_id)) %>%
  group_by(labcase_id) %>% 
  filter(n() > 1) %>%
  select(Name, labcase_id, GUID) %>%
  arrange(labcase_id))

```

### Referenced LabCase project

```{r fig.width=15}

assets_aris_df %>%
  count(labcase_project) %>%
  ggplot(aes(labcase_project, n)) +
    geom_bar(stat = "identity", fill = "#0899CC") +
    geom_text(aes(label = n)) +
    coord_flip() +
    theme_bw()


```








## Merge LabCase and ARIS data

```{r}

lc_reduced <- assets_lc_df %>% select(name, id)
aris_reduced <- assets_aris_df %>% select(Name, labcase_id)

# Check which assets in ARIS have a match in LabCase 

dim(semi_join(aris_reduced, lc_reduced, by = c("labcase_id" = "id")))


# Check which assests in LabCase have a match in ARIS

dim(semi_join(lc_reduced, aris_reduced, by = c("id" = "labcase_id")))




```

```{r}

dim(anti_join(lc_reduced, aris_reduced, by = c("id" = "labcase_id")))

```


